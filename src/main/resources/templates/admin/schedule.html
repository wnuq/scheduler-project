<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{fragments/layout :: main(~{::content}, ~{::title}, ~{::scripts})}">
<head>
    <title>Kalendarz Admina | DriveMaster</title>
</head>
<body>

<div th:fragment="content">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h2 class="fw-bold"><i class="bi bi-calendar-check-fill me-2 text-primary"></i>ZarzÄ…dzanie Grafikiem</h2>
            <p class="text-muted">Blokuj terminy lub zarzÄ…dzaj rezerwacjami kursantÃ³w.</p>
        </div>
        <div class="col-md-4 text-md-end">
            <a href="/admin/dashboard" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>PowrÃ³t do Listy
            </a>
        </div>
    </div>

    <!-- Alerty -->
    <div th:if="${success}" class="alert alert-success border-0 shadow-sm alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger border-0 shadow-sm alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div id='calendar' class="border-0"></div>

    <!-- Forms for actions -->
    <form id="adminForm" method="post" style="display:none;">
        <input type="hidden" name="dateTime" id="actionDateTime">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    </form>
</div>

<th:block th:fragment="scripts">
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            firstDay: 1,
            slotMinTime: '08:00:00',
            slotMaxTime: '20:00:00',
            allDaySlot: false,
            height: 'auto',
            locale: 'pl',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'timeGridWeek,timeGridDay'
            },
            buttonText: {
                today: 'DziÅ›',
                week: 'TydzieÅ„',
                day: 'DzieÅ„'
            },
            events: function(info, successCallback, failureCallback) {
                fetch('/admin/api/schedule?start=' + info.startStr.split('T')[0])
                    .then(response => response.json())
                    .then(data => {
                        const events = data.map(event => {
                            if (event.extendedProps.status === 'FREE') {
                                event.backgroundColor = '#dcfce7';
                                event.borderColor = '#22c55e';
                                event.textColor = '#166534';
                            } else if (event.extendedProps.status === 'BLOCKED') {
                                event.backgroundColor = '#f1f5f9';
                                event.borderColor = '#94a3b8';
                                event.textColor = '#475569';
                                event.title = 'ðŸš« ZABLOKOWANE';
                            } else if (event.extendedProps.status === 'BOOKED') {
                                event.backgroundColor = '#fee2e2';
                                event.borderColor = '#ef4444';
                                event.textColor = '#991b1b';
                            }
                            return event;
                        });
                        successCallback(events);
                    })
                    .catch(error => failureCallback(error));
            },
            eventClick: function(info) {
                var props = info.event.extendedProps;
                if (!props.clickable) return;

                var d = info.event.start;
                var isoLocal = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 19);
                document.getElementById('actionDateTime').value = isoLocal;
                var form = document.getElementById('adminForm');

                if (props.status === 'FREE') {
                    if (confirm('Czy chcesz ZABLOKOWAÄ† ten termin?')) {
                        form.action = '/admin/block';
                        form.submit();
                    }
                } else if (props.status === 'BLOCKED') {
                    if (confirm('Czy chcesz ODBLOKOWAÄ† ten termin?')) {
                        form.action = '/admin/unblock';
                        form.submit();
                    }
                } else if (props.status === 'BOOKED') {
                    if (confirm('Czy chcesz ANULOWAÄ† rezerwacjÄ™ dla kursanta: ' + info.event.title + '? (Godzina zostanie zwrÃ³cona)')) {
                        form.action = '/admin/cancel';
                        form.submit();
                    }
                }
            }
        });
        calendar.render();
    });
</script>
</th:block>

</body>
</html>