<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grafik SzkoÅ‚y Nauki Jazdy - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        body { padding-top: 20px; }
        #calendar { max-width: 1100px; margin: 40px auto; }
        .fc-event { cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <header class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
        <h1 class="h3">ðŸš— Grafik SzkoÅ‚y Nauki Jazdy (Admin)</h1>
        <nav>
            <a href="/admin/dashboard" class="btn btn-primary me-2">Kursanci</a>
            <a href="/logout" class="btn btn-outline-danger">Wyloguj</a>
        </nav>
    </header>

    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>

    <div id='calendar'></div>
</div>

<!-- Forms for actions -->
<form id="adminForm" method="post" style="display:none;">
    <input type="hidden" name="dateTime" id="actionDateTime">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
</form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            firstDay: 1,
            slotMinTime: '08:00:00',
            slotMaxTime: '20:00:00',
            allDaySlot: false,
            height: 'auto',
            locale: 'pl',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'timeGridWeek,timeGridDay'
            },
            events: function(info, successCallback, failureCallback) {
                fetch('/admin/api/schedule?start=' + info.startStr.split('T')[0])
                    .then(response => response.json())
                    .then(data => successCallback(data))
                    .catch(error => failureCallback(error));
            },
            eventClick: function(info) {
                var props = info.event.extendedProps;
                if (!props.clickable) return;

                var d = info.event.start;
                var isoLocal = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 19);
                document.getElementById('actionDateTime').value = isoLocal;
                var form = document.getElementById('adminForm');

                if (props.status === 'FREE') {
                    if (confirm('Czy chcesz ZABLOKOWAÄ† ten termin?')) {
                        form.action = '/admin/block';
                        form.submit();
                    }
                } else if (props.status === 'BLOCKED') {
                    if (confirm('Czy chcesz ODBLOKOWAÄ† ten termin?')) {
                        form.action = '/admin/unblock';
                        form.submit();
                    }
                } else if (props.status === 'BOOKED') {
                    if (confirm('Czy chcesz ANULOWAÄ† rezerwacjÄ™ dla tego kursanta? (Godzina zostanie zwrÃ³cona)')) {
                        form.action = '/admin/cancel';
                        form.submit();
                    }
                }
            }
        });
        calendar.render();
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
