<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grafik SzkoÅ‚y Nauki Jazdy</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FullCalendar CSS and JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        body { padding-top: 20px; }
        #calendar { max-width: 1100px; margin: 40px auto; }
        .fc-event { cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <header class="d-flex flex-wrap justify-content-center py-3 mb-4 border-bottom">
        <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
            <span class="fs-4">ðŸš— Grafik SzkoÅ‚y Nauki Jazdy</span>
        </a>

        <ul class="nav nav-pills align-items-center">
            <li class="nav-item me-3" th:if="${user.role.name() == 'ADMIN'}">
                <a href="/admin/dashboard" class="btn btn-warning">Panel Admina</a>
            </li>
            <li class="nav-item me-3">
                <span class="badge bg-primary fs-6">
                    PozostaÅ‚o godzin: <span th:text="${remainingHours}">30</span>
                </span>
            </li>
            <li class="nav-item me-3">
                <span th:text="${user.firstName} + ' ' + ${user.lastName}">Jan Kowalski</span>
            </li>
            <!-- Prosty Logout (Clerk/OAuth2 zazwyczaj wymaga przekierowania do endpointu wylogowania) -->
            <li class="nav-item"><a href="/logout" class="btn btn-outline-danger">Wyloguj</a></li>
        </ul>
    </header>

    <!-- Alerty -->
    <div th:if="${success}" class="alert alert-success" role="alert" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-danger" role="alert" th:text="${error}"></div>

    <div id='calendar'></div>
</div>

<!-- Hidden form for booking -->
<form id="bookingForm" method="post" action="/schedule/book" style="display:none;">
    <input type="hidden" name="dateTime" id="bookingDateTime">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
</form>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            firstDay: 1, // PoniedziaÅ‚ek
            slotMinTime: '08:00:00',
            slotMaxTime: '20:00:00',
            allDaySlot: false,
            height: 'auto',
            locale: 'pl',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'timeGridWeek,timeGridDay'
            },
            events: function(info, successCallback, failureCallback) {
                // Fetch events from our API
                // FullCalendar passes startStr and endStr
                fetch('/api/schedule?start=' + info.startStr.split('T')[0])
                    .then(response => response.json())
                    .then(data => successCallback(data))
                    .catch(error => failureCallback(error));
            },
            eventClick: function(info) {
                var props = info.event.extendedProps;
                if (props.clickable) {
                    if (confirm('Czy na pewno chcesz zarezerwowaÄ‡ termin: ' + info.event.start.toLocaleString() + '?')) {
                        // Submit hidden form
                        // Convert Date to ISO string expected by backend (LocalDateTime)
                        // Note: JS toISOString() uses UTC. We need local time sending.
                        // Simple hack: format manually or use library. Let's do simple formatting.
                        var d = info.event.start;
                        // Format: YYYY-MM-DDTHH:mm:ss
                        var isoLocal = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 19);
                        
                        document.getElementById('bookingDateTime').value = isoLocal;
                        document.getElementById('bookingForm').submit();
                    }
                } else {
                    // alert('Ten termin nie jest dostÄ™pny do rezerwacji.');
                }
            }
        });
        calendar.render();
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
