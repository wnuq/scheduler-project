<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{fragments/layout :: main(~{::content}, ~{::title}, ~{::scripts})}">
<head>
    <title>Grafik | DriveMaster</title>
</head>
<body>

<div th:fragment="content">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2 class="fw-bold"><i class="bi bi-calendar3 me-2 text-primary"></i>Twój Grafik Rezerwacji</h2>
            <p class="text-muted">Kliknij w wolny termin, aby zarezerwować godzinę jazdy.</p>
        </div>
    </div>

    <!-- Alerty -->
    <div th:if="${success}" class="alert alert-success border-0 shadow-sm alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill me-2"></i>
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <div th:if="${error}" class="alert alert-danger border-0 shadow-sm alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div id='calendar' class="border-0"></div>

    <!-- Hidden form for booking -->
    <form id="bookingForm" method="post" th:action="@{/schedule/book}" style="display:none;">
        <input type="hidden" name="dateTime" id="bookingDateTime">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
    </form>
</div>

<th:block th:fragment="scripts">
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            firstDay: 1,
            slotMinTime: '08:00:00',
            slotMaxTime: '20:00:00',
            allDaySlot: false,
            height: 'auto',
            locale: 'pl',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'timeGridWeek,timeGridDay'
            },
            buttonText: {
                today: 'Dziś',
                week: 'Tydzień',
                day: 'Dzień'
            },
            events: function(info, successCallback, failureCallback) {
                fetch('/api/schedule?start=' + info.startStr.split('T')[0])
                    .then(response => response.json())
                    .then(data => {
                        // Możemy dodać kolory na podstawie statusu bezpośrednio tutaj jeśli API ich nie zwraca
                        const events = data.map(event => {
                            if (event.extendedProps.status === 'FREE') {
                                event.backgroundColor = '#dcfce7';
                                event.borderColor = '#22c55e';
                                event.textColor = '#166534';
                            } else if (event.extendedProps.status === 'BOOKED') {
                                event.backgroundColor = '#dbeafe';
                                event.borderColor = '#2563eb';
                                event.textColor = '#1e40af';
                            }
                            return event;
                        });
                        successCallback(events);
                    })
                    .catch(error => failureCallback(error));
            },
            eventClick: function(info) {
                var props = info.event.extendedProps;
                if (props.clickable) {
                    if (confirm('Czy na pewno chcesz zarezerwować termin: ' + info.event.start.toLocaleString('pl-PL') + '?')) {
                        var d = info.event.start;
                        var isoLocal = new Date(d.getTime() - (d.getTimezoneOffset() * 60000)).toISOString().slice(0, 19);
                        document.getElementById('bookingDateTime').value = isoLocal;
                        document.getElementById('bookingForm').submit();
                    }
                }
            }
        });
        calendar.render();
    });
</script>
</th:block>

</body>
</html>